<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KOI 3D Space Visualization</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<style>
  body{margin:0; font-family:'Segoe UI', Helvetica, Arial, sans-serif; background:#f8f9fa}
  #wrap{position:relative; width:100%; height:min(95vh,100svh); min-height:640px; overflow:hidden;}
  #title{position:absolute; top:16px; left:16px; z-index:10; color:#333; font-weight:700; font-size:20px}
  #sub{font-size:13px; color:#666; font-weight:400; margin-top:4px}

  /* KPI strip */
  #kpis{position:absolute; top:60px; left:16px; z-index:9; display:flex; gap:12px}
  .kpi{background:rgba(255,255,255,0.98); padding:12px 16px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.1); min-width:120px; transition:transform 0.2s}
  .kpi:hover{transform:translateY(-2px); box-shadow:0 4px 16px rgba(0,0,0,.12)}
  .kpi .v{font-size:24px; font-weight:700; color:#222; line-height:1}
  .kpi .l{font-size:11px; color:#666; margin-top:4px; text-transform:uppercase; letter-spacing:.05em}

  #panel{position:absolute; top:12px; right:12px; z-index:10; background:rgba(255,255,255,0.98);
         padding:14px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.1); min-width:260px}
  #panel label{display:block; font-size:12px; color:#555; margin:10px 0 6px; font-weight:500}
  #panel select, #panel input[type="text"], #panel input[type="range"]{width:100%; padding:6px 10px; margin-bottom:8px; border:1px solid #ddd; border-radius:8px; background:#fff}
  #panel select:focus, #panel input[type="text"]:focus{border-color:#4C78A8; outline:none; box-shadow:0 0 0 2px rgba(76,120,168,.2)}
  #legend{margin-top:10px; font-size:12px; max-height:180px; overflow-y:auto; padding-right:4px}
  .legend-item{display:flex; align-items:center; margin:6px 0; cursor:pointer; transition:opacity 0.2s}
  .legend-item:hover{opacity:0.8}
  .legend-dot{width:14px; height:14px; border-radius:50%; margin-right:8px; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.2)}
  
  #tip{position:absolute; z-index:1000; background:rgba(20,20,20,.95); color:#fff; padding:10px 14px; border-radius:8px; font-size:13px; pointer-events:none; display:none; backdrop-filter:blur(10px); box-shadow:0 4px 12px rgba(0,0,0,.3)}
  #tip strong{color:#4C78A8; font-size:14px}
  #tip .row{margin:4px 0}
  
  #footer{position:absolute; bottom:12px; left:16px; z-index:5; font-size:12px; color:#666; background:rgba(255,255,255,.95); padding:8px 12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .pill{display:inline-block; padding:3px 10px; border-radius:999px; background:#e8eaed; margin-right:8px; color:#555; font-weight:500}
  
  /* Loading spinner */
  #loader{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100}
  .spinner{border:3px solid #f3f3f3; border-top:3px solid #4C78A8; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="wrap">
  <div id="loader"><div class="spinner"></div></div>
  <div id="title">KOI 3D Space Explorer<div id="sub">4,619 Kepler Objects ‚Ä¢ 10 transit/orbital features + 4 FP flags ‚Ä¢ t-SNE embedding</div></div>

  <!-- KPI blocks -->
  <div id="kpis">
    <div class="kpi"><div id="kpi-total" class="v">‚Äî</div><div class="l">Total Objects</div></div>
    <div class="kpi"><div id="kpi-cand"  class="v">‚Äî</div><div class="l">Candidates</div></div>
    <div class="kpi"><div id="kpi-conf"  class="v">‚Äî</div><div class="l">Confirmed</div></div>
  </div>

  <div id="panel">
    <label>Color by</label>
    <select id="colorMode">
      <option value="actual">Actual label (CONFIRMED/CANDIDATE)</option>
      <option value="cluster">Cluster (unsupervised)</option>
    </select>

    <label>Search by ID/name</label>
    <input id="q" type="text" placeholder="e.g., 11446443 or Kepler-22"/>

    <label>Point spread</label>
    <input id="spread" type="range" min="0.5" max="4" step="0.1" value="2.5"/>

    <label>Point size</label>
    <input id="psize" type="range" min="0.3" max="2.0" step="0.1" value="1.0"/>

    <div id="legend"></div>
  </div>
  
  <div id="tip"></div>
  
  <div id="footer">
    <span class="pill">üñ±Ô∏è drag = orbit</span>
    <span class="pill">‚öôÔ∏è wheel = zoom</span>
    <span class="pill">‚å®Ô∏è shift+drag = pan</span>
  </div>
</div>

<script>
const actualColor = {"0":"#DC143C","1":"#32CD32"};  // Crimson for candidates, Lime green for confirmed
const clusterPalette = ["#4C78A8","#F58518","#E45756","#72B7B2","#54A24B","#EECA3B","#B279A2","#FF9DA6","#9D755D","#BAB0AC"];
const clusterColor = c => clusterPalette[Math.abs(c) % clusterPalette.length];

async function loadData(){
  const res = await fetch("koi_tsne3d_points.json", {cache:"no-cache"});
  if(!res.ok) throw new Error("Failed to load data: "+res.status);
  return await res.json();
}

function normalize(d){
  const xs=d.map(v=>v.x), ys=d.map(v=>v.y), zs=d.map(v=>v.z);
  const minx=Math.min(...xs), maxx=Math.max(...xs);
  const miny=Math.min(...ys), maxy=Math.max(...ys);
  const minz=Math.min(...zs), maxz=Math.max(...zs);
  const scale = 100 / Math.max(maxx-minx, maxy-miny, maxz-minz);
  
  d.forEach(v=>{ 
    v.X=(v.x - minx - (maxx-minx)/2)*scale; 
    v.Y=(v.y - miny - (maxy-miny)/2)*scale; 
    v.Z=(v.z - minz - (maxz-minz)/2)*scale;
    v.X0=v.X; v.Y0=v.Y; v.Z0=v.Z;
  });
  return d;
}

function createAxisLabel(text, pos, color='#333'){
  const c=document.createElement('canvas'), ctx=c.getContext('2d'); 
  c.width=128; c.height=128;
  ctx.font='bold 48px Arial'; 
  ctx.fillStyle=color; 
  ctx.textAlign='center'; 
  ctx.textBaseline='middle'; 
  ctx.fillText(text, 64, 64);
  
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(c), transparent:true})); 
  s.position.copy(pos); 
  s.scale.set(5,5,1); 
  return s;
}

function buildLegend(el, mode, data, actualGroup, clusterGroup){
  el.innerHTML='';
  if (mode==='actual'){
    [['#DC143C','CANDIDATE ('+data.filter(d=>d.actual_label===0).length+')'],
     ['#32CD32','CONFIRMED ('+data.filter(d=>d.actual_label===1).length+')']].forEach(([c,n])=>{
      const div=document.createElement('div'); 
      div.className='legend-item';
      div.innerHTML=`<span class="legend-dot" style="background:${c}"></span><span>${n}</span>`;
      el.appendChild(div);
    });
    actualGroup.visible=true; 
    clusterGroup.visible=false;
  } else {
    const clusterCounts = {};
    data.forEach(d => { clusterCounts[d.cluster] = (clusterCounts[d.cluster] || 0) + 1; });
    const uniq=[...new Set(data.map(d=>d.cluster))].sort((a,b)=>a-b);
    
    uniq.forEach(c=>{
      const col=clusterColor(c);
      const div=document.createElement('div'); 
      div.className='legend-item';
      div.innerHTML=`<span class="legend-dot" style="background:${col}"></span><span>Cluster ${c} (${clusterCounts[c]})</span>`;
      el.appendChild(div);
    });
    actualGroup.visible=false; 
    clusterGroup.visible=true;
  }
}

// Main visualization
loadData().then(DATA=>{
  normalize(DATA);
  
  // Hide loader
  document.getElementById('loader').style.display='none';

  // Update KPIs
  const total = DATA.length;
  const confirmed = DATA.filter(d=>d.actual_label===1).length;
  const candidates = total - confirmed;
  document.getElementById('kpi-total').textContent = total.toLocaleString();
  document.getElementById('kpi-cand').textContent  = candidates.toLocaleString();
  document.getElementById('kpi-conf').textContent  = confirmed.toLocaleString();

  // Setup Three.js
  const wrap = document.getElementById('wrap');
  const renderer = new THREE.WebGLRenderer({antialias:true, alpha:false}); 
  wrap.appendChild(renderer.domElement);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  const scene = new THREE.Scene(); 
  scene.background = new THREE.Color(0xf8f9fa);
  scene.fog = new THREE.Fog(0xf8f9fa, 200, 500);
  
  const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000); 
  camera.position.set(120, 80, 120);
  
  function fit(){ 
    const w=wrap.clientWidth, h=wrap.clientHeight; 
    renderer.setSize(w,h,false); 
    camera.aspect=w/h; 
    camera.updateProjectionMatrix(); 
  }
  fit(); 
  new ResizeObserver(fit).observe(wrap);

  // Controls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping=true; 
  controls.dampingFactor=.05; 
  controls.minDistance=30; 
  controls.maxDistance=400;
  controls.autoRotate = false;
  controls.autoRotateSpeed = 0.5;
  
  // Lighting
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dl=new THREE.DirectionalLight(0xffffff, 0.4); 
  dl.position.set(50, 100, 50);
  dl.castShadow = true;
  scene.add(dl);
  
  const dl2=new THREE.DirectionalLight(0xffffff, 0.2); 
  dl2.position.set(-50, 50, -50);
  scene.add(dl2);
  
  // Grid and axes
  const grid = new THREE.GridHelper(200, 20, 0xcccccc, 0xeeeeee);
  scene.add(grid);

  // Coordinate axes
  const axes=new THREE.Group();
  const axisLength = 100;
  
  // X axis - Red
  axes.add(new THREE.Line(
    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(axisLength,0,0)]),
    new THREE.LineBasicMaterial({color:0xff0000, linewidth:2})
  ));
  
  // Y axis - Green  
  axes.add(new THREE.Line(
    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,axisLength,0)]),
    new THREE.LineBasicMaterial({color:0x00ff00, linewidth:2})
  ));
  
  // Z axis - Blue
  axes.add(new THREE.Line(
    new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,axisLength)]),
    new THREE.LineBasicMaterial({color:0x0000ff, linewidth:2})
  ));
  scene.add(axes);
  
  // Axis labels
  scene.add(createAxisLabel('X', new THREE.Vector3(110,0,0), '#ff0000'));
  scene.add(createAxisLabel('Y', new THREE.Vector3(0,110,0), '#00ff00'));
  scene.add(createAxisLabel('Z', new THREE.Vector3(0,0,110), '#0000ff'));

  // Create geometry and materials
  const sphere = new THREE.SphereGeometry(0.5, 12, 12);
  const matCandidate = new THREE.MeshPhongMaterial({ 
    color: 0xDC143C,
    emissive: 0xDC143C,
    emissiveIntensity: 0.2,
    shininess: 100
  });
  const matConfirmed = new THREE.MeshPhongMaterial({ 
    color: 0x32CD32,
    emissive: 0x32CD32,
    emissiveIntensity: 0.2,
    shininess: 100
  });
  
  const clusterMaterials = clusterPalette.map(col => new THREE.MeshPhongMaterial({ 
    color: col,
    emissive: col,
    emissiveIntensity: 0.1,
    shininess: 80
  }));

  // Create point groups
  const actualGroup = new THREE.Group();
  const clusterGroup = new THREE.Group();
  scene.add(actualGroup, clusterGroup);

  const actualMeshes = [];
  const clusterMeshes = [];
  
  // Create mesh instances
  DATA.forEach((d, i) => {
    // Actual label mesh
    const mat = d.actual_label === 1 ? matConfirmed : matCandidate;
    const mesh = new THREE.Mesh(sphere, mat);
    mesh.position.set(d.X, d.Y, d.Z);
    mesh.userData = { index: i, data: d };
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    actualGroup.add(mesh);
    actualMeshes.push(mesh);
    
    // Cluster mesh
    const clusterIdx = Math.abs(d.cluster) % clusterPalette.length;
    const clusterMesh = new THREE.Mesh(sphere, clusterMaterials[clusterIdx]);
    clusterMesh.position.set(d.X, d.Y, d.Z);
    clusterMesh.userData = { index: i, data: d };
    clusterMesh.castShadow = true;
    clusterMesh.receiveShadow = true;
    clusterGroup.add(clusterMesh);
    clusterMeshes.push(clusterMesh);
  });

  // Interactive spread + size controls
  const spreadEl = document.getElementById('spread');
  const psizeEl  = document.getElementById('psize');
  
  function updatePositions(){
    const spread = parseFloat(spreadEl.value);
    const psize  = parseFloat(psizeEl.value);
    DATA.forEach((d, i) => {
      const x = d.X0 * spread, y = d.Y0 * spread, z = d.Z0 * spread;
      actualMeshes[i].position.set(x, y, z);
      actualMeshes[i].scale.set(psize, psize, psize);
      clusterMeshes[i].position.set(x, y, z);
      clusterMeshes[i].scale.set(psize, psize, psize);
    });
  }
  
  spreadEl.addEventListener('input', updatePositions);
  psizeEl.addEventListener('input', updatePositions);
  updatePositions();

  // Legend + toggle
  const legend = document.getElementById('legend');
  const modeSel = document.getElementById('colorMode');
  
  function refreshLegend(){ 
    buildLegend(legend, modeSel.value, DATA, actualGroup, clusterGroup); 
  }
  modeSel.addEventListener('change', refreshLegend); 
  refreshLegend();

  // Search functionality
  document.getElementById('q').addEventListener('keydown', e=>{
    if(e.key!=='Enter') return;
    const needle = e.target.value.trim().toLowerCase(); 
    if(!needle) return;
    
    const i = DATA.findIndex(d =>
      (d.kepid && String(d.kepid).toLowerCase().includes(needle)) ||
      (d.kepler_name && d.kepler_name.toLowerCase().includes(needle))
    );
    
    if (i>=0){
      const spread = parseFloat(spreadEl.value);
      const d = DATA[i]; 
      const target = new THREE.Vector3(d.X0*spread, d.Y0*spread, d.Z0*spread);
      
      // Smooth camera transition
      controls.target.lerp(target, 0.5);
      const newPos = new THREE.Vector3(target.x+40, target.y+40, target.z+40);
      camera.position.lerp(newPos, 0.5);
      
      // Highlight ring
      const ring = new THREE.Mesh(
        new THREE.TorusGeometry(3, 0.3, 8, 20), 
        new THREE.MeshBasicMaterial({color:0xFFD700, transparent:true, opacity:0.9})
      );
      ring.position.copy(target); 
      scene.add(ring);
      
      // Animate ring
      let scale = 1;
      const animateRing = () => {
        scale += 0.02;
        ring.scale.set(scale, scale, scale);
        ring.material.opacity = Math.max(0, 0.9 - (scale-1)*2);
        if(ring.material.opacity > 0) {
          requestAnimationFrame(animateRing);
        } else {
          scene.remove(ring);
        }
      };
      animateRing();
      
      // Clear search after animation
      setTimeout(() => e.target.value = '', 1500);
    } else {
      // Flash red border if not found
      e.target.style.borderColor = '#ff4444';
      setTimeout(() => e.target.style.borderColor = '', 500);
    }
  });

  // Enhanced tooltip
  const tip = document.getElementById('tip');
  const ray = new THREE.Raycaster(); 
  const mouse = new THREE.Vector2();
  
  function onMove(e){
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((e.clientX-rect.left)/rect.width)*2 - 1;
    mouse.y = -((e.clientY-rect.top)/rect.height)*2 + 1;
    ray.setFromCamera(mouse, camera);
    
    const target = (modeSel.value==='actual') ? actualGroup : clusterGroup;
    const hits = ray.intersectObjects(target.children);
    
    if (hits.length){
      const d = hits[0].object.userData.data;
      const name = d.kepler_name && d.kepler_name !== 'nan' ? d.kepler_name : 'Unnamed';
      
      tip.innerHTML = `
        <strong>${name}</strong>
        <div class="row">KepID: ${d.kepid}</div>
        <div class="row">Status: <span style="color:${d.actual_label===1?'#32CD32':'#DC143C'}">${d.actual_label_name}</span></div>
        <div class="row">Cluster: ${d.cluster}</div>
        <div class="row">Radius: ${Number.isFinite(d.koi_prad)?d.koi_prad.toFixed(2)+' R‚äï':'‚Äî'}</div>
        <div class="row">Temp: ${Number.isFinite(d.koi_teq)?d.koi_teq.toFixed(0)+' K':'‚Äî'}</div>
      `;
      tip.style.display='block'; 
      tip.style.left=(e.clientX+15)+'px'; 
      tip.style.top=(e.clientY-20)+'px';
      document.body.style.cursor='pointer';
      
      // Highlight on hover
      hits[0].object.scale.setScalar(parseFloat(psizeEl.value) * 1.5);
    } else { 
      tip.style.display='none'; 
      document.body.style.cursor='default';
      
      // Reset all scales
      const psize = parseFloat(psizeEl.value);
      actualMeshes.forEach(m => m.scale.setScalar(psize));
      clusterMeshes.forEach(m => m.scale.setScalar(psize));
    }
  }
  renderer.domElement.addEventListener('mousemove', onMove);
  renderer.domElement.addEventListener('mouseleave', () => {
    tip.style.display='none';
    document.body.style.cursor='default';
  });

  // Animation loop
  function animate(){ 
    controls.update(); 
    renderer.render(scene, camera); 
    requestAnimationFrame(animate); 
  } 
  animate();
  
}).catch(err=>{
  document.getElementById('loader').style.display='none';
  document.body.innerHTML = '<div style="padding:40px; text-align:center; color:#d32f2f"><h2>Error Loading Data</h2><pre style="white-space:pre-wrap">'+String(err)+'</pre><p>Make sure koi_tsne3d_points.json is in the same directory</p></div>';
});
</script>
</body>
</html>