<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Mammal Space</title>

  <!-- Three.js core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- OrbitControls (match same version as Three) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    /* Page */
    body{
      margin:0;
      font-family:Helvetica, sans-serif;
      background:white;
      overflow-x:hidden; /* avoid sideways jiggle */
    }

    /* Canvas container: tall on mobile, stable on desktop */
    #canvas-container{
      position:relative;
      width:100%;
      height:min(95vh, 100svh);
      min-height:600px;
      overflow:hidden;
    }

    /* Title */
    #title{
      position:absolute; top:20px; left:20px;
      font-size:20px; font-weight:bold; color:#333; z-index:100;
    }

    /* Slim legend */
    #legend{
      position:absolute; top:12px; right:12px; z-index:100;
      background:rgba(255,255,255,0.95);
      padding:10px; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
      width:clamp(110px, 28vw, 150px);
    }
    .legend-item{ display:flex; align-items:center; margin:4px 0; font-size:12px; }
    .legend-dot{ width:12px; height:12px; border-radius:50%; background:white; margin-right:6px; }

    /* Tooltip */
    #tooltip{
      position:absolute; z-index:1000;
      background:rgba(0,0,0,0.9); color:white;
      padding:8px 12px; border-radius:5px; font-size:13px;
      pointer-events:none; display:none; box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }

    /* Tablet / small screens */
    @media (max-width:768px){
      #canvas-container{ height:min(90vh, 100svh); min-height:560px; }
      #title{ font-size:16px; top:10px; left:10px; }
      #legend{ top:12px; right:12px; padding:8px; width:clamp(100px, 40vw, 140px); }
      .legend-item{ font-size:11px; margin:3px 0; }
    }

    /* Phones */
    @media (max-width:480px){
      #legend{ top:10px; right:10px; padding:8px; width:clamp(100px, 40vw, 140px); }
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <div id="title">3D Mammal Space</div>

    <div id="legend">
      <div class="legend-item">
        <span class="legend-dot" style="border:2px solid #B22222;"></span><span>Carnivores</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot" style="border:2px solid #008080;"></span><span>Marsupials</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot" style="border:2px solid #4B0082;"></span><span>Primates</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot" style="border:2px solid #228B22;"></span><span>Rodents</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot" style="border:2px solid #DAA520;"></span><span>Ungulates</span>
      </div>
    </div>

    <div id="tooltip"></div>
  </div>

  <script>
    // Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    // Camera
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000); // aspect set after sizing
    camera.position.set(15, 15, 15);

    // Renderer sized to container
    const canvasContainer = document.getElementById('canvas-container');
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.domElement.style.width = '100%';
    renderer.domElement.style.height = '100%';
    renderer.domElement.style.touchAction = 'none'; // reliable gestures on mobile
    canvasContainer.appendChild(renderer.domElement);

    function fitToContainer(){
      const w = canvasContainer.clientWidth;
      const h = canvasContainer.clientHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    fitToContainer();
    new ResizeObserver(fitToContainer).observe(canvasContainer);

    // Mobile: widen FOV slightly
    if (window.innerWidth < 768) { camera.fov = 85; camera.updateProjectionMatrix(); }

    // Controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = true;
    controls.enableZoom = true;
    controls.minDistance = 10;
    controls.maxDistance = 50;
    controls.maxPolarAngle = Math.PI * 0.95;
    controls.target.set(0, 0, 0);

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dir = new THREE.DirectionalLight(0xffffff, 0.3);
    dir.position.set(10, 10, 5);
    scene.add(dir);

    // Grid
    scene.add(new THREE.GridHelper(20, 20, 0xe0e0e0, 0xf0f0f0));

    // Axes
    const axesGroup = new THREE.Group();
    axesGroup.add(
      new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(12,0,0)]), new THREE.LineBasicMaterial({ color: 0x000000 })),
      new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,12,0)]), new THREE.LineBasicMaterial({ color: 0x000000 })),
      new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,12)]), new THREE.LineBasicMaterial({ color: 0x000000 }))
    );
    scene.add(axesGroup);

    // Axis labels
    function createAxisLabel(text, position){
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d');
      c.width = 64; c.height = 64;
      ctx.font = 'bold 48px Arial';
      ctx.fillStyle = 'black';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, 32, 32);
      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(c) }));
      sprite.position.copy(position);
      sprite.scale.set(1, 1, 1);
      return sprite;
    }
    scene.add(createAxisLabel('X', new THREE.Vector3(13, 0, 0)));
    scene.add(createAxisLabel('Y', new THREE.Vector3(0, 13, 0)));
    scene.add(createAxisLabel('Z', new THREE.Vector3(0, 0, 13)));

    // Emojis
    const animalEmojis = {
      'Bears':'ðŸ»','Leopards':'ðŸ†','Lions':'ðŸ¦','Tigers':'ðŸ…','Wolves':'ðŸº',
      'Kangaroos':'ðŸ¦˜','Koalas':'ðŸ¨','Opossums':'ðŸ¦«','Wallabies':'ðŸ¦˜','Wombats':'ðŸ¦«',
      'Baboons':'ðŸµ','Capuchin Monkeys':'ðŸ’','Chimpanzees':'ðŸ¦','Gorillas':'ðŸ¦','Orangutans':'ðŸ¦§',
      'Beavers':'ðŸ¦«','Mice':'ðŸ­','Porcupines':'ðŸ¦”','Rats':'ðŸ€','Squirrels':'ðŸ¿ï¸',
      'Deer':'ðŸ¦Œ','Elk':'ðŸ¦Œ','Giraffes':'ðŸ¦’','Moose':'ðŸ¦Œ','Zebras':'ðŸ¦“'
    };

    // Groups
    const groups = {
      Carnivores:{ color:0xB22222, hexColor:'#B22222', animals:['Bears','Leopards','Lions','Tigers','Wolves'], center:[-4,2,-3] },
      Marsupials:{ color:0x008080, hexColor:'#008080', animals:['Kangaroos','Koalas','Opossums','Wallabies','Wombats'], center:[8,-3,7] },
      Primates:{ color:0x4B0082, hexColor:'#4B0082', animals:['Baboons','Capuchin Monkeys','Chimpanzees','Gorillas','Orangutans'], center:[-7,6,5] },
      Rodents:{ color:0x228B22, hexColor:'#228B22', animals:['Beavers','Mice','Porcupines','Rats','Squirrels'], center:[3,-1,-6] },
      Ungulates:{ color:0xDAA520, hexColor:'#DAA520', animals:['Deer','Elk','Giraffes','Moose','Zebras'], center:[-1,1,2] }
    };

    function createAnimalSprite(animal, groupColor){
      const size = 256;
      const c = document.createElement('canvas');
      const ctx = c.getContext('2d');
      c.width = size; c.height = size;

      ctx.fillStyle = groupColor;
      ctx.beginPath(); ctx.arc(size/2, size/2, size/2 - 10, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = 'white';
      ctx.beginPath(); ctx.arc(size/2, size/2, size/2 - 20, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = groupColor; ctx.lineWidth = 8;
      ctx.beginPath(); ctx.arc(size/2, size/2, size/2 - 14, 0, Math.PI*2); ctx.stroke();

      ctx.font = 'bold 140px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(animalEmojis[animal] || 'ðŸ¾', size/2, size/2);

      const texture = new THREE.CanvasTexture(c);
      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, sizeAttenuation:true }));
      sprite.scale.set(1.5, 1.5, 1);
      return sprite;
    }

    const animalSprites = [];
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const tooltip = document.getElementById('tooltip');

    // Build groups
    Object.entries(groups).forEach(([groupName, groupData])=>{
      // faint center sphere
      const centerMesh = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 16, 16),
        new THREE.MeshPhongMaterial({ color: groupData.color, transparent:true, opacity:0.2 })
      );
      centerMesh.position.set(...groupData.center);
      scene.add(centerMesh);

      // animal sprites
      groupData.animals.forEach((animal, i)=>{
        const angle = (i / groupData.animals.length) * Math.PI * 2;
        const radius = 2.5;
        const yJitter = (Math.random() - 0.5) * 1.5;

        const x = groupData.center[0] + Math.cos(angle) * radius + (Math.random() - 0.5) * 0.8;
        const y = groupData.center[1] + yJitter;
        const z = groupData.center[2] + Math.sin(angle) * radius + (Math.random() - 0.5) * 0.8;

        const sprite = createAnimalSprite(animal, groupData.hexColor);
        sprite.position.set(x, y, z);
        sprite.userData = { group: groupName, animal };
        scene.add(sprite);
        animalSprites.push(sprite);

        // subtle tether
        const line = new THREE.Line(
          new THREE.BufferGeometry().setFromPoints([ new THREE.Vector3(...groupData.center), new THREE.Vector3(x, y, z) ]),
          new THREE.LineBasicMaterial({ color: groupData.color, opacity:0.15, transparent:true })
        );
        scene.add(line);
      });

      // group label
      const lc = document.createElement('canvas');
      const lctx = lc.getContext('2d');
      lc.width = 256; lc.height = 64;
      lctx.fillStyle = 'rgba(255,255,255,0.95)'; lctx.fillRect(0,0,256,64);
      lctx.font = 'bold 30px Arial'; lctx.fillStyle = '#333'; lctx.textAlign = 'center';
      lctx.fillText(groupName, 128, 40);
      const labelSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(lc) }));
      labelSprite.position.set(groupData.center[0], groupData.center[1] + 3.5, groupData.center[2]);
      labelSprite.scale.set(4, 1, 1);
      scene.add(labelSprite);
    });

    // Hover tooltip (use canvas bounding rect)
    function onPointerMove(event){
      const rect = renderer.domElement.getBoundingClientRect();
      const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      mouse.set(x, y);

      raycaster.setFromCamera(mouse, camera);
      const hit = raycaster.intersectObjects(animalSprites);

      if (hit.length > 0){
        const obj = hit[0].object;
        const data = obj.userData;
        tooltip.innerHTML = `<strong>${animalEmojis[data.animal]} ${data.animal}</strong><br>Group: ${data.group}`;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX + 10) + 'px';
        tooltip.style.top  = (event.clientY - 30) + 'px';
        document.body.style.cursor = 'pointer';
      } else {
        tooltip.style.display = 'none';
        document.body.style.cursor = 'default';
      }
    }
    renderer.domElement.addEventListener('mousemove', onPointerMove);

    // Animate
    let time = 0;
    function animate(){
      requestAnimationFrame(animate);
      time += 0.01;
      animalSprites.forEach((s, i)=>{ s.position.y += Math.sin(time + i * 0.5) * 0.002; });
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
